on:
  delete:
    branches:
      - 'test/**'

env:
  BRANCH_NAME: ${{ github.event.ref }}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    name: Delete Cloudflare Page
    steps:
      - name: Set Project Name
        run: |
          export NAME=$(echo ${{ env.BRANCH_NAME }} | tr -d -c '[:alnum:]')
          echo "PROJECT_NAME=${NAME:0:10}" >> $GITHUB_ENV

      - name: Delete preview project
        run: |
          curl --request DELETE \
            --url https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ env.PROJECT_NAME }} \
            --header 'Content-Type: application/json' \
            --header 'Authorization: Bearer ${{ secrets.CF_PAGES_API_TOKEN }}'
